<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - Standalone</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .connect-btn { background-color: #28a745; color: white; }
        .disconnect-btn { background-color: #dc3545; color: white; }
        .send-btn { background-color: #007bff; color: white; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #messages {
            border: 1px solid #ddd;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            margin-top: 20px;
            background-color: #f8f9fa;
            font-family: monospace;
            font-size: 12px;
        }
        .log {
            margin: 2px 0;
            padding: 3px;
            border-left: 3px solid #007bff;
        }
        .error { border-left-color: #dc3545; color: #721c24; }
        .success { border-left-color: #28a745; color: #155724; }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            width: 200px;
        }
        fieldset {
            margin: 15px 0;
            background-color: #f9f9f9;
        }
        legend {
            font-weight: bold;
            color: #007bff;
            padding: 0 10px;
        }
        #notificationForm {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>WebSocket Test - Standalone</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div>
        <button id="connectBtn" class="connect-btn" onclick="testConnection()">Connect via WebSocket</button>
        <button id="disconnectBtn" class="disconnect-btn" onclick="disconnect()" disabled>Disconnect</button>
    </div>
    
    <div id="notificationForm" style="display: none; border: 1px solid #ddd; padding: 15px; margin: 10px 0;">
        <h3>Send Notification</h3>
        
        <!-- Emergency Unit Section -->
        <fieldset style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
            <legend>Emergency Unit (Optional)</legend>
            <div class="form-group">
                <label>Unit ID:</label>
                <input type="number" id="unitId" placeholder="Leave empty to skip">
            </div>
            <div class="form-group">
                <label>Unit Type:</label>
                <input type="text" id="unitType" placeholder="e.g., Ambulance, Fire Truck" style="width: 300px;">
            </div>
            <div class="form-group">
                <label>Latitude:</label>
                <input type="number" step="0.000001" id="unitLatitude" placeholder="e.g., 40.7128">
            </div>
            <div class="form-group">
                <label>Longitude:</label>
                <input type="number" step="0.000001" id="unitLongitude" placeholder="e.g., -74.0060">
            </div>
            <div class="form-group">
                <label>Capacity:</label>
                <input type="number" id="unitCapacity" placeholder="e.g., 4">
            </div>
            <div class="form-group">
                <label>Status:</label>
                <select id="unitStatus">
                    <option value="true">Active</option>
                    <option value="false">Inactive</option>
                </select>
            </div>
            <button onclick="createEmergencyUnit()" style="background-color: #17a2b8; color: white; padding: 5px 10px; margin: 5px;">Create Emergency Unit</button>
        </fieldset>
        
        <!-- Incident Section -->
        <fieldset style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
            <legend>Incident (Optional)</legend>
            <div class="form-group">
                <label>Incident ID:</label>
                <input type="number" id="incidentId" placeholder="Leave empty to skip">
            </div>
            <div class="form-group">
                <label>Incident Type:</label>
                <input type="text" id="incidentType" placeholder="e.g., Fire, Medical Emergency" style="width: 300px;">
            </div>
            <div class="form-group">
                <label>Latitude:</label>
                <input type="number" step="0.000001" id="incidentLatitude" placeholder="e.g., 40.7831">
            </div>
            <div class="form-group">
                <label>Longitude:</label>
                <input type="number" step="0.000001" id="incidentLongitude" placeholder="e.g., -73.9712">
            </div>
            <div class="form-group">
                <label>Needs:</label>
                <input type="text" id="incidentNeeds" placeholder="e.g., Fire suppression" style="width: 300px;">
            </div>
            <div class="form-group">
                <label>Severity Level:</label>
                <select id="incidentSeverity">
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                </select>
            </div>
            <div class="form-group">
                <label>Reported Time:</label>
                <input type="date" id="incidentReportedTime">
            </div>
            <button onclick="createIncident()" style="background-color: #17a2b8; color: white; padding: 5px 10px; margin: 5px;">Create Incident</button>
        </fieldset>
        
        <!-- User Section -->
        <fieldset style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
            <legend>User (REQUIRED)</legend>
            <div class="form-group">
                <label>User ID: <span style="color: red;">*</span></label>
                <input type="number" id="userId" placeholder="Enter user ID" required>
            </div>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="userName" placeholder="e.g., dispatcher1" style="width: 300px;">
            </div>
            <div class="form-group">
                <label>First Name:</label>
                <input type="text" id="userFname" placeholder="e.g., John">
            </div>
            <div class="form-group">
                <label>Last Name:</label>
                <input type="text" id="userLname" placeholder="e.g., Doe">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="userPassword" placeholder="Password">
            </div>
            <div class="form-group">
                <label>Role:</label>
                <select id="userRole">
                    <option value="user">User</option>
                    <option value="dispatcher">Dispatcher</option>
                    <option value="administrator">Administrator</option>
                    <option value="emergency_responder">Emergency Responder</option>
                    <option value="supervisor">Supervisor</option>
                </select>
            </div>
            <button onclick="createUser()" style="background-color: #17a2b8; color: white; padding: 5px 10px; margin: 5px;">Create User</button>
        </fieldset>
        
        <!-- Notification Message -->
        <div class="form-group" style="margin-top: 15px;">
            <label><strong>Notification Message:</strong></label>
            <input type="text" id="message" value="Emergency notification test" placeholder="Enter notification message" style="width: 500px;">
        </div>
        
        <button class="send-btn" onclick="sendNotification()" style="margin-top: 10px; font-size: 16px; padding: 10px 20px;">Send Notification via WebSocket</button>
    </div>

    <!-- Location Update Section -->
    <div id="locationUpdateForm" style="display: none; border: 1px solid #ddd; padding: 15px; margin: 10px 0;">
        <h3>Update Emergency Unit Location (WebSocket)</h3>
        
        <fieldset style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
            <legend>Location Update</legend>
            <div class="form-group">
                <label>Unit ID: <span style="color: red;">*</span></label>
                <input type="number" id="locationUnitId" placeholder="Enter Unit ID">
            </div>
            <div class="form-group">
                <label>Latitude: <span style="color: red;">*</span></label>
                <input type="number" id="locationLatitude" step="0.000001" placeholder="e.g., 40.7128">
            </div>
            <div class="form-group">
                <label>Longitude: <span style="color: red;">*</span></label>
                <input type="number" id="locationLongitude" step="0.000001" placeholder="e.g., -74.0060">
            </div>
        </fieldset>
        
        <button class="send-btn" onclick="updateLocation()" style="margin-top: 10px; font-size: 16px; padding: 10px 20px;">Update Location via WebSocket</button>
        
        <div style="margin-top: 15px; padding: 10px; background-color: #e7f3ff; border-left: 4px solid #2196F3;">
            <h4 style="margin: 0 0 10px 0;">Latest Location Updates:</h4>
            <div id="locationUpdates" style="font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
                <em>Waiting for location updates...</em>
            </div>
        </div>
    </div>
    
    <!-- Create Assignment Form -->
    <div id="createAssignmentForm" style="display: none; border: 1px solid #ddd; padding: 15px; margin: 10px 0; background-color: #f0f8ff;">
        <h3>‚ûï Create New Assignment</h3>
        <p style="color: #666; font-size: 14px;">User assigns an incident to an emergency unit</p>
        
        <fieldset style="border: 1px solid #ccc; padding: 10px; margin: 10px 0;">
            <legend>Assignment Details</legend>
            <div class="form-group">
                <label>User ID: <span style="color: red;">*</span></label>
                <input type="number" id="assignUserId" placeholder="Enter User ID">
            </div>
            <div class="form-group">
                <label>Incident ID: <span style="color: red;">*</span></label>
                <input type="number" id="assignIncidentId" placeholder="Enter Incident ID">
            </div>
            <div class="form-group">
                <label>Emergency Unit ID: <span style="color: red;">*</span></label>
                <input type="number" id="assignUnitId" placeholder="Enter Emergency Unit ID">
            </div>
        </fieldset>
        
        <button class="send-btn" onclick="createAssignment()" style="margin-top: 10px; font-size: 16px; padding: 10px 20px; background-color: #17a2b8;">Create Assignment</button>
        
        <div style="margin-top: 10px; padding: 8px; background-color: #d1ecf1; border-left: 4px solid #17a2b8; font-size: 12px; color: #0c5460;">
            ‚ÑπÔ∏è <strong>Note:</strong> Creating an assignment will automatically set the Emergency Unit status to ACTIVE
        </div>
    </div>
    
    <!-- Assignment Monitoring Section -->
    <div id="assignmentMonitor" style="display: none; border: 1px solid #ddd; padding: 15px; margin: 10px 0; background-color: #f9f9f9;">
        <h3>üìã Real-Time Assignment Monitor</h3>
        <p style="color: #666; font-size: 14px;">Watch assignments as they are created and deactivated in real-time</p>
        
        <div style="margin: 10px 0;">
            <button class="send-btn" onclick="requestAllAssignments()" style="font-size: 14px;">üîÑ Refresh All Assignments</button>
            <button class="send-btn" onclick="requestActiveAssignments()" style="font-size: 14px; background-color: #28a745;">‚úì Show Active Only</button>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background-color: white; border: 1px solid #ddd; border-radius: 4px;">
            <h4 style="margin: 0 0 10px 0; color: #007bff;">üìä Live Assignments:</h4>
            <div id="assignmentsList" style="max-height: 400px; overflow-y: auto;">
                <em style="color: #999;">Waiting for assignment updates...</em>
            </div>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107;">
            <h4 style="margin: 0 0 10px 0; color: #856404;">üí° How it works:</h4>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px; color: #666;">
                <li>Create assignments via REST API (POST /api/assignments)</li>
                <li>Assignments appear here automatically in real-time</li>
                <li>Active status (‚úì Active / ‚úó Inactive) updates instantly</li>
                <li>Shows User, Incident, Emergency Unit details</li>
            </ul>
        </div>
    </div>
    
    <!-- Emergency Units System Monitor -->
    <div id="unitsMonitor" style="display: none; border: 1px solid #ddd; padding: 15px; margin: 10px 0; background-color: #f0fff4;">
        <h3>üö® Emergency Units System Monitor</h3>
        <p style="color: #666; font-size: 14px;">Real-time monitoring of all emergency units and their current assignments</p>
        
        <div style="margin: 10px 0;">
            <button class="send-btn" onclick="refreshUnitsMonitor()" style="font-size: 14px; background-color: #17a2b8;">üîÑ Refresh All Units</button>
            <button class="send-btn" onclick="filterAvailableUnits()" style="font-size: 14px; background-color: #28a745;">‚úì Show Available Only</button>
            <button class="send-btn" onclick="filterBusyUnits()" style="font-size: 14px; background-color: #ffc107;">‚ö† Show Busy Only</button>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background-color: white; border: 1px solid #ddd; border-radius: 4px;">
            <h4 style="margin: 0 0 10px 0; color: #007bff;">üöí Live Units Status:</h4>
            <div id="unitsMonitorList" style="max-height: 500px; overflow-y: auto;">
                <em style="color: #999;">Loading emergency units...</em>
            </div>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background-color: #e7f3ff; border-left: 4px solid #2196F3;">
            <h4 style="margin: 0 0 10px 0; color: #0c5460;">üìä System Statistics:</h4>
            <div id="unitsStats" style="font-size: 14px; color: #333;">
                <div>Total Units: <strong id="totalUnits">0</strong></div>
                <div>Available Units: <strong id="availableUnits" style="color: #28a745;">0</strong></div>
                <div>Busy Units: <strong id="busyUnits" style="color: #dc3545;">0</strong></div>
            </div>
        </div>
        
        <div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107;">
            <h4 style="margin: 0 0 10px 0; color: #856404;">üí° Features:</h4>
            <ul style="margin: 5px 0; padding-left: 20px; font-size: 13px; color: #666;">
                <li>Real-time updates when assignments are created/completed</li>
                <li>Shows current assignment details for busy units</li>
                <li>Color-coded status (Green=Available, Red=Busy)</li>
                <li>Unit location and capacity information</li>
            </ul>
        </div>
    </div>
    
    <div id="messages"></div>
    
    <script>
        let ws = null;
        let connected = false;

        function log(message, type = 'log') {
            const messagesDiv = document.getElementById('messages');
            const logDiv = document.createElement('div');
            logDiv.className = 'log ' + type;
            logDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            messagesDiv.appendChild(logDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            console.log(message);
        }

        function updateStatus(isConnected) {
            connected = isConnected;
            const statusDiv = document.getElementById('status');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');
            const notificationForm = document.getElementById('notificationForm');
            const locationUpdateForm = document.getElementById('locationUpdateForm');
            const createAssignmentForm = document.getElementById('createAssignmentForm');
            const assignmentMonitor = document.getElementById('assignmentMonitor');
            const unitsMonitor = document.getElementById('unitsMonitor');
            
            if (isConnected) {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'status connected';
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
                notificationForm.style.display = 'block';
                locationUpdateForm.style.display = 'block';
                createAssignmentForm.style.display = 'block';
                assignmentMonitor.style.display = 'block';
                unitsMonitor.style.display = 'block';
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                notificationForm.style.display = 'none';
                locationUpdateForm.style.display = 'none';
                createAssignmentForm.style.display = 'none';
                assignmentMonitor.style.display = 'none';
                unitsMonitor.style.display = 'none';
            }
        }

        function testConnection() {
            log('Starting WebSocket connection test...');
            
            try {
                // Use native WebSocket instead of SockJS for simplicity
                const wsUrl = `ws://localhost:9696/ws/websocket`;
                log(`Attempting to connect to: ${wsUrl}`);
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function(event) {
                    log('WebSocket connection opened successfully!', 'success');
                    
                    // Send STOMP CONNECT frame manually (using actual newlines, not escaped)
                    log('Sending STOMP CONNECT frame...');
                    const connectFrame = 'CONNECT\naccept-version:1.2\nhost:localhost\n\n\0';
                    ws.send(connectFrame);
                };
                
                ws.onmessage = function(event) {
                    log('Received: ' + event.data, 'success');
                    
                    if (event.data.startsWith('CONNECTED')) {
                        log('STOMP connection established!', 'success');
                        updateStatus(true);
                        
                        // Subscribe to notification topic
                        log('Subscribing to /topic/notify...');
                        const subscribeFrame = 'SUBSCRIBE\nid:sub-0\ndestination:/topic/notify\n\n\0';
                        ws.send(subscribeFrame);
                        
                        // Subscribe to error topic
                        log('Subscribing to /topic/notify/errors...');
                        const subscribeErrorFrame = 'SUBSCRIBE\nid:sub-1\ndestination:/topic/notify/errors\n\n\0';
                        ws.send(subscribeErrorFrame);
                        
                        // Subscribe to location updates
                        log('Subscribing to /topic/unit-location...');
                        const subscribeLocationFrame = 'SUBSCRIBE\nid:sub-2\ndestination:/topic/unit-location\n\n\0';
                        ws.send(subscribeLocationFrame);
                        
                        // Subscribe to location errors
                        log('Subscribing to /topic/unit-location/errors...');
                        const subscribeLocationErrorFrame = 'SUBSCRIBE\nid:sub-3\ndestination:/topic/unit-location/errors\n\n\0';
                        ws.send(subscribeLocationErrorFrame);
                        
                        // Subscribe to assignment updates (real-time notifications)
                        log('Subscribing to /topic/assignments...');
                        const subscribeAssignmentsFrame = 'SUBSCRIBE\nid:sub-4\ndestination:/topic/assignments\n\n\0';
                        ws.send(subscribeAssignmentsFrame);
                        
                        // Subscribe to all assignments responses
                        log('Subscribing to /topic/assignments/all...');
                        const subscribeAssignmentsAllFrame = 'SUBSCRIBE\nid:sub-5\ndestination:/topic/assignments/all\n\n\0';
                        ws.send(subscribeAssignmentsAllFrame);
                        
                        // Subscribe to active assignments responses
                        log('Subscribing to /topic/assignments/active...');
                        const subscribeAssignmentsActiveFrame = 'SUBSCRIBE\nid:sub-6\ndestination:/topic/assignments/active\n\n\0';
                        ws.send(subscribeAssignmentsActiveFrame);
                        
                        // Subscribe to assignment errors
                        log('Subscribing to /topic/assignments/errors...');
                        const subscribeAssignmentsErrorFrame = 'SUBSCRIBE\nid:sub-7\ndestination:/topic/assignments/errors\n\n\0';
                        ws.send(subscribeAssignmentsErrorFrame);
                        
                        // Subscribe to units monitor
                        log('Subscribing to /topic/units-monitor...');
                        const subscribeUnitsMonitorFrame = 'SUBSCRIBE\nid:sub-8\ndestination:/topic/units-monitor\n\n\0';
                        ws.send(subscribeUnitsMonitorFrame);
                        
                        // Subscribe to units monitor updates
                        log('Subscribing to /topic/units-monitor/update...');
                        const subscribeUnitsMonitorUpdateFrame = 'SUBSCRIBE\nid:sub-9\ndestination:/topic/units-monitor/update\n\n\0';
                        ws.send(subscribeUnitsMonitorUpdateFrame);
                        
                        // Request initial assignment list
                        setTimeout(() => requestAllAssignments(), 500);
                        
                        // Request initial units monitor status
                        setTimeout(() => refreshUnitsMonitor(), 1000);
                    } else if (event.data.includes('MESSAGE')) {
                        // Parse STOMP MESSAGE frame
                        const lines = event.data.split('\n');
                        
                        // Check which topic this message is from
                        const destinationLine = lines.find(line => line.startsWith('destination:'));
                        const destination = destinationLine ? destinationLine.split(':')[1] : '';
                        
                        const bodyIndex = lines.findIndex(line => line === '');
                        if (bodyIndex > 0 && bodyIndex < lines.length - 1) {
                            const body = lines.slice(bodyIndex + 1).join('\n').replace(/\0$/, '');
                            try {
                                const parsed = JSON.parse(body);
                                
                                if (destination.includes('/topic/unit-location')) {
                                    log('Location update received: ' + JSON.stringify(parsed, null, 2), 'success');
                                    displayLocationUpdate(parsed);
                                } else if (destination.includes('/topic/units-monitor/update')) {
                                    log('Unit status update received', 'success');
                                    updateSingleUnitDisplay(parsed);
                                } else if (destination.includes('/topic/units-monitor')) {
                                    log('All units status received: ' + parsed.length + ' units', 'success');
                                    displayAllUnits(parsed);
                                } else if (destination.includes('/topic/assignments/all')) {
                                    log('All assignments received: ' + parsed.length + ' assignments', 'success');
                                    displayAssignmentsList(parsed);
                                } else if (destination.includes('/topic/assignments/active')) {
                                    log('Active assignments received: ' + parsed.length + ' assignments', 'success');
                                    displayAssignmentsList(parsed);
                                } else if (destination.includes('/topic/assignments')) {
                                    log('Assignment update received: ' + JSON.stringify(parsed, null, 2), 'success');
                                    displaySingleAssignment(parsed);
                                } else if (destination.includes('/topic/notify')) {
                                    log('Notification received: ' + JSON.stringify(parsed, null, 2), 'success');
                                } else {
                                    log('Message received: ' + JSON.stringify(parsed, null, 2), 'success');
                                }
                            } catch (e) {
                                log('Message body: ' + body, 'success');
                            }
                        }
                    }
                };
                
                ws.onerror = function(error) {
                    log('WebSocket error: ' + JSON.stringify(error), 'error');
                    updateStatus(false);
                };
                
                ws.onclose = function(event) {
                    log(`WebSocket closed. Code: ${event.code}, Reason: ${event.reason || 'No reason provided'}`, 'error');
                    updateStatus(false);
                };
                
            } catch (error) {
                log('Exception during connection: ' + error.message, 'error');
                updateStatus(false);
            }
        }

        function sendNotification() {
            if (!connected || !ws) {
                log('Not connected to WebSocket', 'error');
                return;
            }

            const userId = parseInt(document.getElementById('userId').value);
            const message = document.getElementById('message').value;

            // Validate User ID (required)
            if (isNaN(userId) || userId <= 0) {
                log('User ID is required!', 'error');
                alert('User ID is required! Please enter a valid User ID or create a new user.');
                return;
            }

            // Build notification object
            const notification = {
                user: { userID: userId },
                message: message || "Emergency notification"
            };

            // Add Emergency Unit if provided
            const unitId = parseInt(document.getElementById('unitId').value);
            if (!isNaN(unitId) && unitId > 0) {
                notification.emergencyUnit = { unitID: unitId };
            }

            // Add Incident if provided
            const incidentId = parseInt(document.getElementById('incidentId').value);
            if (!isNaN(incidentId) && incidentId > 0) {
                notification.incident = { incidentId: incidentId };
            }

            log('Sending notification: ' + JSON.stringify(notification, null, 2));

            // Send STOMP SEND frame
            const sendFrame = `SEND\ndestination:/app/notify.sendNotification\ncontent-type:application/json\n\n${JSON.stringify(notification)}\0`;
            ws.send(sendFrame);
            
            log('Notification sent!', 'success');
        }

        // Location Update Functions
        function updateLocation() {
            if (!connected || !ws) {
                log('Not connected to WebSocket', 'error');
                return;
            }

            const unitId = parseInt(document.getElementById('locationUnitId').value);
            const latitude = parseFloat(document.getElementById('locationLatitude').value);
            const longitude = parseFloat(document.getElementById('locationLongitude').value);

            // Validate inputs
            if (isNaN(unitId) || unitId <= 0) {
                log('Unit ID is required!', 'error');
                alert('Unit ID is required! Please enter a valid Unit ID.');
                return;
            }

            if (isNaN(latitude) || isNaN(longitude)) {
                log('Latitude and Longitude are required!', 'error');
                alert('Latitude and Longitude are required! Please enter valid coordinates.');
                return;
            }

            // Build location update object
            const locationUpdate = {
                unitId: unitId,
                latitude: latitude,
                longitude: longitude
            };

            log('Sending location update: ' + JSON.stringify(locationUpdate, null, 2));

            // Send STOMP SEND frame
            const sendFrame = `SEND\ndestination:/app/unit.updateLocation\ncontent-type:application/json\n\n${JSON.stringify(locationUpdate)}\0`;
            ws.send(sendFrame);
            
            log('Location update sent!', 'success');
        }

        function displayLocationUpdate(locationData) {
            const locationUpdatesDiv = document.getElementById('locationUpdates');
            
            // Clear "waiting" message on first update
            if (locationUpdatesDiv.innerHTML.includes('Waiting for location updates')) {
                locationUpdatesDiv.innerHTML = '';
            }
            
            const updateDiv = document.createElement('div');
            updateDiv.style.cssText = 'padding: 8px; margin: 5px 0; background-color: white; border-left: 3px solid #4CAF50; border-radius: 3px;';
            
            const timestamp = new Date(locationData.timestamp || Date.now()).toLocaleString();
            updateDiv.innerHTML = `
                <strong>Unit #${locationData.unitId}</strong> - ${locationData.type || 'Unknown'} (${locationData.status || 'Unknown'})<br>
                <span style="color: #666;">Location: ${locationData.latitude.toFixed(6)}, ${locationData.longtitude.toFixed(6)}</span><br>
                <span style="color: #999; font-size: 10px;">${timestamp}</span>
            `;
            
            locationUpdatesDiv.insertBefore(updateDiv, locationUpdatesDiv.firstChild);
            
            // Keep only last 10 updates
            while (locationUpdatesDiv.children.length > 10) {
                locationUpdatesDiv.removeChild(locationUpdatesDiv.lastChild);
            }
        }

        // REST API Functions
        async function createUser() {
            const userName = document.getElementById('userName').value;
            const fname = document.getElementById('userFname').value;
            const lname = document.getElementById('userLname').value;
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            if (!userName || !fname || !lname || !password) {
                log('Please fill in all user fields', 'error');
                alert('Please fill in all user fields (Username, First Name, Last Name, Password)');
                return;
            }

            const user = {
                userName: userName,
                fname: fname,
                lname: lname,
                password: password,
                role: role
            };

            log('Creating user via REST API: ' + JSON.stringify(user, null, 2));

            try {
                const response = await fetch('http://localhost:9696/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(user)
                });

                if (response.ok) {
                    const createdUser = await response.json();
                    log('User created successfully! User ID: ' + createdUser.userID, 'success');
                    document.getElementById('userId').value = createdUser.userID;
                    alert('User created successfully! User ID: ' + createdUser.userID);
                } else {
                    const errorText = await response.text();
                    log('Failed to create user: ' + errorText, 'error');
                    alert('Failed to create user. Check console for details.');
                }
            } catch (error) {
                log('Error creating user: ' + error.message, 'error');
                alert('Error creating user: ' + error.message);
            }
        }

        async function createEmergencyUnit() {
            const type = document.getElementById('unitType').value;
            const latitude = parseFloat(document.getElementById('unitLatitude').value);
            const longtitude = parseFloat(document.getElementById('unitLongitude').value);
            const capacity = parseInt(document.getElementById('unitCapacity').value);
            const status = document.getElementById('unitStatus').value === 'true';

            if (!type || isNaN(latitude) || isNaN(longtitude) || isNaN(capacity)) {
                log('Please fill in all emergency unit fields', 'error');
                alert('Please fill in all emergency unit fields (Type, Latitude, Longitude, Capacity)');
                return;
            }

            const unit = {
                type: type,
                latitude: latitude,
                longtitude: longtitude,
                capacity: capacity,
                status: status
            };

            log('Creating emergency unit via REST API: ' + JSON.stringify(unit, null, 2));

            try {
                const response = await fetch('http://localhost:9696/api/emergency-units', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(unit)
                });

                if (response.ok) {
                    const createdUnit = await response.json();
                    log('Emergency Unit created successfully! Unit ID: ' + createdUnit.unitID, 'success');
                    document.getElementById('unitId').value = createdUnit.unitID;
                    alert('Emergency Unit created successfully! Unit ID: ' + createdUnit.unitID);
                } else {
                    const errorText = await response.text();
                    log('Failed to create emergency unit: ' + errorText, 'error');
                    alert('Failed to create emergency unit. Check console for details.');
                }
            } catch (error) {
                log('Error creating emergency unit: ' + error.message, 'error');
                alert('Error creating emergency unit: ' + error.message);
            }
        }

        async function createIncident() {
            const type = document.getElementById('incidentType').value;
            const latitude = parseFloat(document.getElementById('incidentLatitude').value);
            const longtitude = parseFloat(document.getElementById('incidentLongitude').value);
            const needs = document.getElementById('incidentNeeds').value;
            const severityLevel = document.getElementById('incidentSeverity').value;
            const reportedTime = document.getElementById('incidentReportedTime').value;

            if (!type || isNaN(latitude) || isNaN(longtitude) || !needs || !reportedTime) {
                log('Please fill in all incident fields', 'error');
                alert('Please fill in all incident fields (Type, Latitude, Longitude, Needs, Reported Time)');
                return;
            }

            const incident = {
                type: type,
                latitude: latitude,
                longtitude: longtitude,
                needs: needs,
                severityLevel: severityLevel,
                reportedTime: reportedTime
            };

            log('Creating incident via REST API: ' + JSON.stringify(incident, null, 2));

            try {
                const response = await fetch('http://localhost:9696/api/incidents', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(incident)
                });

                if (response.ok) {
                    const createdIncident = await response.json();
                    log('Incident created successfully! Incident ID: ' + createdIncident.incidentId, 'success');
                    document.getElementById('incidentId').value = createdIncident.incidentId;
                    alert('Incident created successfully! Incident ID: ' + createdIncident.incidentId);
                } else {
                    const errorText = await response.text();
                    log('Failed to create incident: ' + errorText, 'error');
                    alert('Failed to create incident. Check console for details.');
                }
            } catch (error) {
                log('Error creating incident: ' + error.message, 'error');
                alert('Error creating incident: ' + error.message);
            }
        }

        // Assignment Functions
        async function createAssignment() {
            const userId = parseInt(document.getElementById('assignUserId').value);
            const incidentId = parseInt(document.getElementById('assignIncidentId').value);
            const unitId = parseInt(document.getElementById('assignUnitId').value);

            // Validate inputs
            if (isNaN(userId) || userId <= 0) {
                log('User ID is required!', 'error');
                alert('User ID is required! Please enter a valid User ID.');
                return;
            }

            if (isNaN(incidentId) || incidentId <= 0) {
                log('Incident ID is required!', 'error');
                alert('Incident ID is required! Please enter a valid Incident ID.');
                return;
            }

            if (isNaN(unitId) || unitId <= 0) {
                log('Emergency Unit ID is required!', 'error');
                alert('Emergency Unit ID is required! Please enter a valid Emergency Unit ID.');
                return;
            }

            const assignment = {
                userId: userId,
                incidentId: incidentId,
                unitId: unitId
            };

            log('Creating assignment via REST API: ' + JSON.stringify(assignment, null, 2));

            try {
                const response = await fetch('http://localhost:9696/api/assignments', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(assignment)
                });

                if (response.ok) {
                    const createdAssignment = await response.json();
                    log('Assignment created successfully! Assignment ID: ' + createdAssignment.assignmentId, 'success');
                    alert(`Assignment created successfully!\nAssignment ID: ${createdAssignment.assignmentId}\nEmergency Unit is now ACTIVE`);
                    
                    // Clear the form
                    document.getElementById('assignUserId').value = '';
                    document.getElementById('assignIncidentId').value = '';
                    document.getElementById('assignUnitId').value = '';
                } else {
                    const errorData = await response.json();
                    log('Failed to create assignment: ' + errorData.error, 'error');
                    alert('Failed to create assignment: ' + errorData.error);
                }
            } catch (error) {
                log('Error creating assignment: ' + error.message, 'error');
                alert('Error creating assignment: ' + error.message);
            }
        }

        async function requestAllAssignments() {
            log('Requesting all assignments via REST API...');
            try {
                const response = await fetch('http://localhost:9696/api/assignments');
                if (response.ok) {
                    const assignments = await response.json();
                    log('Retrieved ' + assignments.length + ' assignments', 'success');
                    displayAssignmentsList(assignments);
                } else {
                    log('Failed to retrieve assignments: ' + response.statusText, 'error');
                }
            } catch (error) {
                log('Error retrieving assignments: ' + error.message, 'error');
            }
        }

        async function requestActiveAssignments() {
            log('Requesting active assignments via REST API...');
            try {
                const response = await fetch('http://localhost:9696/api/assignments/active');
                if (response.ok) {
                    const assignments = await response.json();
                    log('Retrieved ' + assignments.length + ' active assignments', 'success');
                    displayAssignmentsList(assignments);
                } else {
                    log('Failed to retrieve active assignments: ' + response.statusText, 'error');
                }
            } catch (error) {
                log('Error retrieving active assignments: ' + error.message, 'error');
            }
        }

        function displayAssignmentsList(assignments) {
            const assignmentsList = document.getElementById('assignmentsList');
            
            if (!assignments || assignments.length === 0) {
                assignmentsList.innerHTML = '<em style="color: #999;">No assignments found</em>';
                return;
            }
            
            assignmentsList.innerHTML = '';
            
            assignments.forEach(assignment => {
                const assignmentDiv = createAssignmentElement(assignment);
                assignmentsList.appendChild(assignmentDiv);
            });
        }

        function displaySingleAssignment(assignment) {
            const assignmentsList = document.getElementById('assignmentsList');
            
            // Clear "waiting" message if present
            if (assignmentsList.innerHTML.includes('Waiting for assignment updates')) {
                assignmentsList.innerHTML = '';
            }
            
            // Check if assignment already exists and update it
            const existingElement = document.getElementById('assignment-' + assignment.assignmentId);
            if (existingElement) {
                existingElement.replaceWith(createAssignmentElement(assignment));
            } else {
                // Add new assignment at the top
                const assignmentDiv = createAssignmentElement(assignment);
                assignmentsList.insertBefore(assignmentDiv, assignmentsList.firstChild);
            }
            
            // Keep only last 20 assignments
            while (assignmentsList.children.length > 20) {
                assignmentsList.removeChild(assignmentsList.lastChild);
            }
        }

        function createAssignmentElement(assignment) {
            const assignmentDiv = document.createElement('div');
            assignmentDiv.id = 'assignment-' + assignment.assignmentId;
            
            const isActive = assignment.isActive;
            const statusColor = isActive ? '#28a745' : '#6c757d';
            const statusText = isActive ? '‚úì ACTIVE' : '‚úó COMPLETED';
            const statusBg = isActive ? '#d4edda' : '#e2e3e5';
            
            assignmentDiv.style.cssText = `
                padding: 12px;
                margin: 8px 0;
                background-color: white;
                border-left: 4px solid ${statusColor};
                border-radius: 4px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            `;
            
            let resolutionInfo = '';
            if (!isActive && assignment.resolutionTime) {
                const assignDate = new Date(assignment.assignmentTime);
                const resolutionDate = new Date(assignment.resolutionTime);
                const days = Math.ceil((resolutionDate - assignDate) / (1000 * 60 * 60 * 24));
                resolutionInfo = `<br><span style="color: #666; font-size: 12px;">‚è±Ô∏è Resolution Time: ${days} day(s)</span>`;
            }
            
            assignmentDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <strong style="font-size: 16px; color: #333;">Assignment #${assignment.assignmentId}</strong>
                        <span style="margin-left: 10px; padding: 3px 8px; background-color: ${statusBg}; color: ${statusColor}; font-size: 11px; font-weight: bold; border-radius: 3px;">
                            ${statusText}
                        </span>
                        <br>
                        <span style="color: #666; font-size: 13px;">
                            üë§ User: <strong>${assignment.user?.userName || 'ID: ' + assignment.user?.userID}</strong> |
                            üö® Incident: <strong>#${assignment.incident?.incidentId}</strong> ${assignment.incident?.type ? '(' + assignment.incident.type + ')' : ''} |
                            üöí Unit: <strong>#${assignment.emergencyUnit?.unitID}</strong> ${assignment.emergencyUnit?.type ? '(' + assignment.emergencyUnit.type + ')' : ''}
                        </span>
                        <br>
                        <span style="color: #999; font-size: 11px;">
                            üìÖ Assigned: ${assignment.assignmentTime}
                            ${assignment.resolutionTime ? ' | ‚úì Resolved: ' + assignment.resolutionTime : ''}
                        </span>
                        ${resolutionInfo}
                    </div>
                    ${isActive ? `<button onclick="deactivateAssignment(${assignment.assignmentId})" style="padding: 5px 10px; background-color: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Deactivate</button>` : ''}
                </div>
            `;
            
            return assignmentDiv;
        }

        async function deactivateAssignment(assignmentId) {
            if (!confirm('Are you sure you want to deactivate assignment #' + assignmentId + '?')) {
                return;
            }
            
            log('Deactivating assignment #' + assignmentId + '...');
            try {
                const response = await fetch(`http://localhost:9696/api/assignments/${assignmentId}/deactivate`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    const updatedAssignment = await response.json();
                    log('Assignment deactivated successfully!', 'success');
                    // The WebSocket will automatically update the UI
                } else {
                    const errorText = await response.text();
                    log('Failed to deactivate assignment: ' + errorText, 'error');
                    alert('Failed to deactivate assignment. Check console for details.');
                }
            } catch (error) {
                log('Error deactivating assignment: ' + error.message, 'error');
                alert('Error deactivating assignment: ' + error.message);
            }
        }

        // Emergency Units Monitor Functions
        let allUnitsData = [];
        
        async function refreshUnitsMonitor() {
            log('Requesting all emergency units status...');
            try {
                const response = await fetch('http://localhost:9696/api/monitor/units');
                if (response.ok) {
                    const units = await response.json();
                    log('Retrieved ' + units.length + ' emergency units', 'success');
                    allUnitsData = units;
                    displayAllUnits(units);
                } else {
                    log('Failed to retrieve units: ' + response.statusText, 'error');
                }
            } catch (error) {
                log('Error retrieving units: ' + error.message, 'error');
            }
        }
        
        function filterAvailableUnits() {
            const availableUnits = allUnitsData.filter(unit => !unit.hasActiveAssignment);
            log('Filtering to show ' + availableUnits.length + ' available units');
            displayAllUnits(availableUnits);
        }
        
        function filterBusyUnits() {
            const busyUnits = allUnitsData.filter(unit => unit.hasActiveAssignment);
            log('Filtering to show ' + busyUnits.length + ' busy units');
            displayAllUnits(busyUnits);
        }
        
        function displayAllUnits(units) {
            const unitsListDiv = document.getElementById('unitsMonitorList');
            
            if (!units || units.length === 0) {
                unitsListDiv.innerHTML = '<em style="color: #999;">No emergency units found</em>';
                updateUnitsStats(0, 0, 0);
                return;
            }
            
            unitsListDiv.innerHTML = '';
            
            let availableCount = 0;
            let busyCount = 0;
            
            units.forEach(unit => {
                if (unit.hasActiveAssignment) {
                    busyCount++;
                } else {
                    availableCount++;
                }
                const unitDiv = createUnitElement(unit);
                unitsListDiv.appendChild(unitDiv);
            });
            
            updateUnitsStats(units.length, availableCount, busyCount);
        }
        
        function updateSingleUnitDisplay(unit) {
            const unitDiv = document.getElementById('unit-' + unit.unitID);
            if (unitDiv) {
                unitDiv.replaceWith(createUnitElement(unit));
            } else {
                // Unit not in current view, refresh all
                refreshUnitsMonitor();
            }
            
            // Update the stored data
            const index = allUnitsData.findIndex(u => u.unitID === unit.unitID);
            if (index !== -1) {
                allUnitsData[index] = unit;
            }
        }
        
        function createUnitElement(unit) {
            const unitDiv = document.createElement('div');
            unitDiv.id = 'unit-' + unit.unitID;
            
            const isBusy = unit.hasActiveAssignment;
            const statusColor = isBusy ? '#dc3545' : '#28a745';
            const statusText = isBusy ? 'üî¥ BUSY' : 'üü¢ AVAILABLE';
            const statusBg = isBusy ? '#f8d7da' : '#d4edda';
            
            unitDiv.style.cssText = `
                padding: 12px;
                margin: 8px 0;
                background-color: white;
                border-left: 4px solid ${statusColor};
                border-radius: 4px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            `;
            
            let assignmentInfo = '';
            if (isBusy && unit.activeAssignment) {
                const assignment = unit.activeAssignment;
                assignmentInfo = `
                    <div style="margin-top: 8px; padding: 8px; background-color: #fff3cd; border-left: 3px solid #ffc107; border-radius: 3px;">
                        <strong style="color: #856404;">üìã Current Assignment:</strong><br>
                        <span style="font-size: 12px; color: #666;">
                            Assignment #${assignment.assignmentId} | 
                            üë§ ${assignment.userName} | 
                            üö® Incident #${assignment.incidentId} (${assignment.incidentType}) | 
                            ‚ö† ${assignment.incidentSeverity}<br>
                            üìÖ Since: ${assignment.assignmentTime}
                        </span>
                    </div>
                `;
            }
            
            unitDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <strong style="font-size: 16px; color: #333;">üöí Unit #${unit.unitID}</strong>
                        <span style="margin-left: 10px; padding: 3px 8px; background-color: ${statusBg}; color: ${statusColor}; font-size: 11px; font-weight: bold; border-radius: 3px;">
                            ${statusText}
                        </span>
                        <br>
                        <span style="color: #666; font-size: 13px;">
                            <strong>Type:</strong> ${unit.type} | 
                            <strong>Capacity:</strong> ${unit.capacity} | 
                            <strong>Location:</strong> ${unit.latitude.toFixed(4)}, ${unit.longtitude.toFixed(4)}
                        </span>
                        ${assignmentInfo}
                    </div>
                </div>
            `;
            
            return unitDiv;
        }
        
        function updateUnitsStats(total, available, busy) {
            document.getElementById('totalUnits').textContent = total;
            document.getElementById('availableUnits').textContent = available;
            document.getElementById('busyUnits').textContent = busy;
        }

        function disconnect() {
            if (ws) {
                log('Sending STOMP DISCONNECT frame...');
                const disconnectFrame = 'DISCONNECT\n\n\0';
                ws.send(disconnectFrame);
                
                setTimeout(() => {
                    ws.close();
                    ws = null;
                }, 100);
            }
            updateStatus(false);
            log('Disconnected');
        }

        // Initialize
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('incidentReportedTime').value = today;
        
        log('Page loaded. Ready to test WebSocket connection.');
        log('Note: This test uses native WebSocket with manual STOMP frames.');
        log('‚ö†Ô∏è You can create entities directly from this page or use existing IDs');
        log('Steps:');
        log('  1. Click "Connect via WebSocket"');
        log('  2. Create User, Emergency Unit, and Incident (or use existing IDs)');
        log('  3. Send notification with the created/existing IDs');
    </script>
</body>
</html>
