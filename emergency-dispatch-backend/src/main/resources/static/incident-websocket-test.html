<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Incident WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
        .status { margin: 10px 0; padding: 8px; border-radius: 4px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        #incidents, #units, #assignments, #completedIncidents, #overdueIncidents {
            margin-top: 20px;
            border: 2px solid #28a745;
            background: #eafaf1;
            padding: 16px;
            min-height: 120px;
            border-radius: 8px;
            box-shadow: 0 2px 8px #28a74522;
        }
        .incident, .unit, .assignment {
            margin: 8px 0;
            padding: 8px;
            background: #fff;
            border-left: 4px solid #007bff;
            border-radius: 3px;
        }
        .unit {
            border-left-color: #28a745;
        }
        .assignment {
            border-left-color: #ff9800;
        }
        .incident .meta, .unit .meta, .assignment .meta {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <h2>Incident WebSocket Test</h2>
    <div id="status" class="status disconnected">Disconnected</div>
    <div style="margin-bottom: 15px;">
        <button id="connectBtn">Connect WebSocket</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
    <fieldset style="margin: 20px 0; border: 2px solid #007bff; padding: 15px;">
        <legend style="color: #007bff; font-size: 16px;">Generate Random Incidents</legend>
        <label for="incidentCount">Number of Incidents:</label>
        <input type="number" id="incidentCount" min="1" max="100" value="3" style="width: 60px;">
        <button id="generateBtn">Generate</button>
        <span id="resultMsg" style="margin-left: 10px; color: #155724;"></span>
    </fieldset>
    <h3>Live Incidents</h3>
    <div id="incidents"><em>Waiting for incidents...</em></div>

    <fieldset style="margin: 20px 0; border: 2px solid #28a745; padding: 15px;">
        <legend style="color: #28a745; font-size: 16px;">Generate Random Emergency Units</legend>
        <label for="unitCount">Number of Units:</label>
        <input type="number" id="unitCount" min="1" max="100" value="3" style="width: 60px;">
        <button id="generateUnitBtn">Generate Units</button>
        <span id="unitResultMsg" style="margin-left: 10px; color: #155724;"></span>
    </fieldset>
    <h3>Live Emergency Units</h3>
    <div id="units" style="margin-top: 20px; border: 2px solid #28a745; background: #eafaf1; padding: 16px; min-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px #28a74522;">
        <em>Waiting for units...</em>
    </div>

    <fieldset style="margin: 20px 0; border: 2px solid #ff9800; padding: 15px;">
        <legend style="color: #ff9800; font-size: 16px;">Simulation Control</legend>
        <button id="startSimBtn">Start Simulation</button>
        <button id="stopSimBtn">Stop Simulation</button>
        <span id="simResultMsg" style="margin-left: 10px; color: #155724;"></span>
    </fieldset>
    <h3>Live Assignments</h3>
    <div id="assignments" style="margin-top: 20px; border: 2px solid #ff9800; background: #fff8e1; padding: 16px; min-height: 120px; border-radius: 8px; box-shadow: 0 2px 8px #ff980022;">
        <em>Waiting for assignments...</em>
    </div>

    <h3>Assignment Completion</h3>
    <div id="assignmentCompleteMsg"><em>No completion messages yet.</em></div>
    <h3>Completed Incidents</h3>
    <div id="completedIncidents"><em>No completed incidents yet.</em></div>

    <h3>Overdue Incidents (Pending > 2 min, No Assignment)</h3>
    <div id="overdueIncidents"><em>No overdue incidents yet.</em></div>

    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
    <script>
        let ws = null;
        let connected = false;
        const statusDiv = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const incidentsDiv = document.getElementById('incidents');
        const resultMsg = document.getElementById('resultMsg');
        let incidents = [];

        function updateStatus(isConnected) {
            connected = isConnected;
            statusDiv.textContent = isConnected ? 'Connected' : 'Disconnected';
            statusDiv.className = 'status ' + (isConnected ? 'connected' : 'disconnected');
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
        }

        // Connect to WebSocket and subscribe to incident updates
        connectBtn.onclick = function() {
            ws = new WebSocket('ws://localhost:9696/ws');
            ws.onopen = function() {
                updateStatus(true);
                // STOMP CONNECT
                ws.send('CONNECT\naccept-version:1.2\nhost:localhost\n\n\0');
                // Subscribe to /topic/incidents after a short delay
                setTimeout(() => {
                    ws.send('SUBSCRIBE\nid:sub-1\ndestination:/topic/incidents\n\n\0');
                }, 300);
            };
            ws.onmessage = function(event) {
                const data = event.data;
                if (data.includes('CONNECTED')) return;
                if (data.includes('MESSAGE')) {
                    const body = data.split('\n\n')[1].replace(/\u0000$/, '');
                    try {
                        const parsed = JSON.parse(body);
                        console.log('WebSocket /topic/incidents received:', parsed); // Debug log
                        if (Array.isArray(parsed)) {
                            // Full incident list broadcast
                            incidents = parsed;
                            renderIncidents();
                        } else {
                            // Single incident broadcast (legacy)
                            const idx = incidents.findIndex(i => i.incidentId === parsed.incidentId);
                            if (idx !== -1) {
                                incidents[idx] = parsed;
                            } else {
                                incidents.push(parsed);
                            }
                            renderIncidents();
                        }
                    } catch (e) {}
                }
            };
            ws.onclose = function() { updateStatus(false); };
            ws.onerror = function() { updateStatus(false); };
        };
        disconnectBtn.onclick = function() {
            if (ws) ws.close();
            updateStatus(false);
        };
        document.getElementById('generateBtn').onclick = function() {
            const count = parseInt(document.getElementById('incidentCount').value, 10);
            if (!count || count < 1) {
                resultMsg.textContent = 'Enter a valid number.';
                return;
            }
            fetch('http://localhost:9696/api/incidents/generate?count=' + count, { method: 'POST' })
                .then(res => res.text())
                .then(msg => { 
                    resultMsg.textContent = msg;
                    // Fetch all incidents to update the list immediately
                    fetch('http://localhost:9696/api/incidents')
                        .then(res => res.json())
                        .then(data => {
                            incidents = data;
                            renderIncidents();
                        });
                })
                .catch(err => { resultMsg.textContent = 'Error: ' + err; });
        };
        function renderIncidents() {
            if (!incidents.length) {
                incidentsDiv.innerHTML = '<em>Waiting for incidents...</em>';
                return;
            }
            incidentsDiv.innerHTML = '';
            incidents.forEach(inc => {
                const div = document.createElement('div');
                div.className = 'incident';
                let statusColor = inc.status === 'PENDING' ? '#007bff' : (inc.status === 'DISPATCH' ? '#ff9800' : '#28a745');
                let statusLabel = inc.status === 'PENDING' ? 'Pending' : (inc.status === 'DISPATCH' ? 'Dispatched' : 'Completed');
                let statusBadge = `<span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:bold; color:#fff; background:${statusColor};margin-left:8px;">${statusLabel}</span>`;
                div.innerHTML = `<strong>Incident #${inc.incidentId}</strong> - <span>${inc.type}</span> <span class="meta">[${inc.severityLevel}]</span> ${statusBadge}<br>
                    <span class="meta">Needs: ${inc.needs}, Location: ${inc.latitude.toFixed(4)}, ${inc.longtitude.toFixed(4)}, Reported: ${inc.reportedTime}</span>`;
                incidentsDiv.appendChild(div);
            });
        }

        // Emergency Units WebSocket using STOMP
        let units = [];
        const unitsDiv = document.getElementById('units');
        const stompUnitsClient = new StompJs.Client({
            brokerURL: 'ws://localhost:9696/ws'
        });
        stompUnitsClient.onConnect = function() {
            stompUnitsClient.subscribe('/topic/emergency-units', function(message) {
                units = JSON.parse(message.body);
                renderUnits();
            });
            // Redis-backed high-frequency location stream
            stompUnitsClient.subscribe('/topic/unit-location-batch', function(message) {
                try {
                    const batch = JSON.parse(message.body);
                    let changed = false;
                    units = units.map(u => {
                        const loc = batch[u.unitID] || batch[String(u.unitID)];
                        if (loc && typeof loc.lat !== 'undefined' && typeof loc.lon !== 'undefined') {
                            const nextLat = parseFloat(loc.lat);
                            const nextLon = parseFloat(loc.lon);
                            if (isFinite(nextLat) && isFinite(nextLon) && (u.latitude !== nextLat || u.longtitude !== nextLon)) {
                                changed = true;
                                return { ...u, latitude: nextLat, longtitude: nextLon };
                            }
                        }
                        return u;
                    });
                    if (changed) renderUnits();
                } catch (e) {
                    console.warn('Failed to apply Redis location batch', e);
                }
            });
            // Request all units on connect
            stompUnitsClient.publish({destination: '/app/units/subscribe', body: ''});
        };
        stompUnitsClient.activate();

        document.getElementById('generateUnitBtn').onclick = function() {
            const count = parseInt(document.getElementById('unitCount').value, 10);
            if (!count || count < 1) {
                unitResultMsg.textContent = 'Enter a valid number.';
                return;
            }
            fetch('http://localhost:9696/api/emergency-units/generator/generate-random?count=' + count, { method: 'POST' })
                .then(res => res.text())
                .then(msg => { unitResultMsg.textContent = msg; })
                .catch(err => { unitResultMsg.textContent = 'Error: ' + err; });
        };
        function renderUnits() {
            if (!units.length) {
                unitsDiv.innerHTML = '<em>Waiting for units...</em>';
                return;
            }
            unitsDiv.innerHTML = '';
            units.forEach(unit => {
                const div = document.createElement('div');
                div.className = 'unit';
                let statusBadge = `<span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:bold; color:#fff; background:${unit.status ? '#28a745' : '#dc3545'};margin-left:8px;">${unit.status ? 'Available' : 'Busy'}</span>`;
                div.innerHTML = `<strong>Unit #${unit.unitID}</strong> - <span>${unit.type}</span> <span class="meta">[Capacity: ${unit.capacity}]</span> ${statusBadge}<br>
                    <span class="meta">Location: ${unit.latitude.toFixed(4)}, ${unit.longtitude.toFixed(4)}</span>`;
                unitsDiv.appendChild(div);
            });
        }

        // Simulation control
        const startSimBtn = document.getElementById('startSimBtn');
        const stopSimBtn = document.getElementById('stopSimBtn');
        const simResultMsg = document.getElementById('simResultMsg');
        startSimBtn.onclick = function() {
            fetch('http://localhost:9696/api/simulation/start', { method: 'POST' })
                .then((res) => res.text())
                .then((msg) => { simResultMsg.textContent = msg; })
                .catch((err) => { simResultMsg.textContent = 'Error: ' + err; });
        };
        stopSimBtn.onclick = function() {
            fetch('http://localhost:9696/api/simulation/stop', { method: 'POST' })
                .then((res) => res.text())
                .then((msg) => { simResultMsg.textContent = msg; })
                .catch((err) => { simResultMsg.textContent = 'Error: ' + err; });
        };
        // Assignments WebSocket using STOMP
        let assignments = [];
        const assignmentsDiv = document.getElementById('assignments');
        const stompClient = new StompJs.Client({
            brokerURL: 'ws://localhost:9696/ws'
        });
        stompClient.onConnect = function() {
            stompClient.subscribe('/topic/assignments/all', function(message) {
                assignments = JSON.parse(message.body);
                renderAssignments();
            });
            // Request all assignments on connect
            stompClient.publish({destination: '/app/assignments.getAll', body: ''});
        };
        stompClient.activate();
        function renderAssignments() {
            if (!assignments.length) {
                assignmentsDiv.innerHTML = '<em>Waiting for assignments...</em>';
                return;
            }
            assignmentsDiv.innerHTML = '';
            assignments.forEach(a => {
                const div = document.createElement('div');
                div.className = 'assignment';
                div.style.borderLeft = a.isActive ? '4px solid #28a745' : '4px solid #dc3545';
                let statusBadge = `<span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:bold; color:#fff; background:${a.isActive ? '#28a745' : '#dc3545'};margin-left:8px;">${a.isActive ? 'Active' : 'Inactive'}</span>`;
                div.innerHTML = `<strong>Assignment #${a.assignmentId}</strong> - <span>Unit: ${a.emergencyUnit ? a.emergencyUnit.unitID : ''}</span> <span>Incident: ${a.incident ? a.incident.incidentId : ''}</span> ${statusBadge}<br>
                    <span class="meta">Assigned: ${a.assignmentTime || ''}</span>`;
                // Add complete button if assignment is active
                if (a.isActive && a.incident && a.incident.incidentId) {
                    const btn = document.createElement('button');
                    btn.textContent = 'Complete';
                    btn.style.marginLeft = '12px';
                    btn.onclick = function() {
                        fetch(`http://localhost:9696/api/io/assignments/complete/${a.incident.incidentId}`, { method: 'POST' })
                            .then(res => res.text())
                            .then(msg => {
                                alert(msg);
                                // Fetch all incidents to update the list immediately
                                fetch('http://localhost:9696/api/incidents')
                                    .then(res => res.json())
                                    .then(data => {
                                        incidents = data;
                                        renderIncidents();
                                    });
                            })
                            .catch(err => alert('Error: ' + err));
                    };
                    div.appendChild(btn);
                }
                assignmentsDiv.appendChild(div);
            });
        }

        // --- Assignment Completion WebSocket ---
        let wsAssignmentComplete = null;
        const assignmentCompleteDiv = document.getElementById('assignmentCompleteMsg');
        function connectAssignmentCompleteWebSocket() {
            wsAssignmentComplete = new WebSocket('ws://localhost:9696/ws');
            wsAssignmentComplete.onopen = function() {
                wsAssignmentComplete.send('CONNECT\naccept-version:1.2\nhost:localhost\n\n\0');
                setTimeout(() => {
                    wsAssignmentComplete.send('SUBSCRIBE\nid:sub-ac\ndestination:/topic/assignment-complete\n\n\0');
                }, 300);
            };
            wsAssignmentComplete.onmessage = function(event) {
                const data = event.data;
                if (data.includes('CONNECTED')) return;
                if (data.includes('MESSAGE')) {
                    const body = data.split('\n\n')[1].replace(/\u0000$/, '');
                    assignmentCompleteDiv.innerHTML = `<strong>${body}</strong>`;
                }
            };
        }
        connectAssignmentCompleteWebSocket();

        // --- Completed Incidents WebSocket ---
        let wsCompletedIncidents = null;
        const completedIncidentsDiv = document.getElementById('completedIncidents');
        function renderCompletedIncidents(incidents) {
            console.log('Received completed incidents:', incidents);
            if (!incidents || !incidents.length) {
                completedIncidentsDiv.innerHTML = '<em>No completed incidents yet.</em>';
                return;
            }
            completedIncidentsDiv.innerHTML = '';
            incidents.forEach(inc => {
                const div = document.createElement('div');
                div.className = 'incident';
                div.innerHTML = `<strong>Incident #${inc.incidentId}</strong> - <span>${inc.type}</span> <span class="meta">[${inc.severityLevel}]</span><br>
                    <span class="meta">Needs: ${inc.needs}, Location: ${inc.latitude?.toFixed(4)}, ${inc.longtitude?.toFixed(4)}, Reported: ${inc.reportedTime}</span>`;
                completedIncidentsDiv.appendChild(div);
            });
        }
        function connectCompletedIncidentsWebSocket() {
            wsCompletedIncidents = new WebSocket('ws://localhost:9696/ws');
            wsCompletedIncidents.onopen = function() {
                wsCompletedIncidents.send('CONNECT\naccept-version:1.2\nhost:localhost\n\n\0');
                setTimeout(() => {
                    wsCompletedIncidents.send('SUBSCRIBE\nid:sub-ci\ndestination:/topic/completed-incidents\n\n\0');
                }, 300);
            };
            wsCompletedIncidents.onmessage = function(event) {
                const data = event.data;
                if (data.includes('CONNECTED')) return;
                if (data.includes('MESSAGE')) {
                    const body = data.split('\n\n')[1].replace(/\u0000$/, '');
                    try {
                        const incidents = JSON.parse(body);
                        renderCompletedIncidents(incidents);
                    } catch (e) {}
                }
            };
        }
        connectCompletedIncidentsWebSocket();

        // --- Overdue Incidents WebSocket ---
        let overdueIncidents = [];
        const overdueIncidentsDiv = document.getElementById('overdueIncidents');
        const stompOverdueClient = new StompJs.Client({
            brokerURL: 'ws://localhost:9696/ws'
        });
        stompOverdueClient.onConnect = function() {
            stompOverdueClient.subscribe('/topic/incidents/overdue', function(message) {
                overdueIncidents = JSON.parse(message.body);
                renderOverdueIncidents();
            });
            // Request all overdue incidents on connect
            stompOverdueClient.publish({destination: '/app/incidents.overdue', body: ''});
            // Poll for overdue incidents every 10 seconds for real-time updates
            setInterval(() => {
                stompOverdueClient.publish({destination: '/app/incidents.overdue', body: ''});
            }, 10000);
        };
        stompOverdueClient.activate();
        function renderOverdueIncidents() {
            if (!overdueIncidents.length) {
                overdueIncidentsDiv.innerHTML = '<em>No overdue incidents yet.</em>';
                return;
            }
            overdueIncidentsDiv.innerHTML = '';
            overdueIncidents.forEach(inc => {
                const div = document.createElement('div');
                div.className = 'incident';
                div.style.borderLeft = '4px solid #dc3545';
                div.innerHTML = `<strong>Incident #${inc.incidentId}</strong> - <span>${inc.type}</span> <span class="meta">[${inc.severityLevel}]</span> <span style="color:#dc3545;font-weight:bold;margin-left:8px;">Overdue</span><br>
                    <span class="meta">Needs: ${inc.needs}, Location: ${inc.latitude.toFixed(4)}, ${inc.longtitude.toFixed(4)}, Reported: ${inc.reportedTime}</span>`;
                overdueIncidentsDiv.appendChild(div);
            });
        }

        // Fetch and display all incidents (including completed) on page load
        fetch('http://localhost:9696/api/incidents')
            .then(res => res.json())
            .then(data => {
                incidents = data;
                renderIncidents();
            });

        // Auto-connect to incident WebSocket on page load
        window.addEventListener('DOMContentLoaded', function() {
            connectBtn.onclick();
        });
    </script>
</body>
</html>
